// client/src/pages/CurriculumMap.jsx
import React, { useEffect, useState, useCallback, memo } from "react";
import ReactFlow, {
  MiniMap,
  Controls,
  Background,
  Handle,
  Position,
  NodeToolbar,
  ReactFlowProvider,
  useReactFlow,
  getRectOfNodes,
} from "reactflow";
import FlowErrorBoundary from "../components/FlowErrorBoundary";
import { motion, AnimatePresence } from "framer-motion"; 
import { toPng } from "html-to-image";
import { jsPDF } from "jspdf";
import "reactflow/dist/style.css";
import axios from "axios";

// =========================================================
// ğŸ¨ åˆ†é¡ â†’ é¡è‰²
// =========================================================
function categoryColor(cat) {
  switch (cat) {
    case "æ ¡å®šå¿…ä¿®": return "#ef4444";
    case "é™¢å®šå¿…ä¿®": return "#f59e0b";
    case "ç³»å®šå¿…ä¿®": return "#10b981";
    case "ç³»ä¸Šé¸ä¿®": return "#3b82f6";
    default: return "#6b7280";
  }
}
// å·¦å´æ¨™é¡Œç”¨
function getYearText(level) {
  switch (level) {
  	case 1: return "ä¸€å¹´ç´šä¸Š";
  	case 2: return "ä¸€å¹´ç´šä¸‹";
  	case 3: return "äºŒå¹´ç´šä¸Š";
  	case 4: return "äºŒå¹´ç´šä¸‹";
  	case 5: return "ä¸‰å¹´ç´šä¸Š";
  	case 6: return "ä¸‰å¹´ç´šä¸‹";
  	case 7: return "å››å¹´ç´šä¸Š";
  	case 8: return "å››å¹´ç´šä¸‹";
  	default: return "æœªåˆ†é¡";
  }
}
// åŒ¯å‡º(ReactFlowProvider å…§éƒ¨æ‰èƒ½é‹ä½œ
function ExportComponent({ isExporting, onExportStart, onExportEnd, mapData }) {
  const { getNodes } = useReactFlow();

  const exportImage = async (type = "PNG") => {
  	onExportStart();
  	const nodes = getNodes();
  	if (nodes.length === 0) {
  	  onExportEnd();
  	  return;
  	}

    try {
      // 1. è¨ˆç®—é‚Šç•Œ (ä¸è®Š)
      const nodesBounds = getRectOfNodes(nodes);
      const PADDING = 40;
      const LABEL_WIDTH = 100;

      // 2. å–å¾— React Flow ç•«å¸ƒ (ä¸è®Š)
      const reactFlowViewport = document.querySelector(".react-flow__viewport");
      if (!reactFlowViewport) throw new Error("æ‰¾ä¸åˆ° .react-flow__viewport");

      // 3. æ“·å– "ç´”åœ°åœ–" åœ–ç‰‡ (ä¸è®Š)
      //    åŠ å…¥ cacheBust: true ç¢ºä¿åœ–ç‰‡æœ€æ–°
      const dataUrl = await toPng(reactFlowViewport, {
        width: nodesBounds.width,
        height: nodesBounds.height,
        pixelRatio: 2,
        style: {
          width: `${nodesBounds.width}px`,
          height: `${nodesBounds.height}px`,
          transform: `translate(${-nodesBounds.x}px, ${-nodesBounds.y}px) scale(1)`,
        },
        cacheBust: true,
      });

      // 4. å»ºç«‹ "åŒ¯å‡ºå°ˆç”¨" DOM çµæ§‹ (ä¸è®Š)
      const exportWrapper = document.createElement("div");
      // â— [ä¿®æ”¹] æ”¹è®Šéš±è— DOM çš„æ–¹å¼
      exportWrapper.style.position = "absolute";
      exportWrapper.style.top = "0"; // æ”¾åœ¨ (0,0)
      exportWrapper.style.left = "0"; // æ”¾åœ¨ (0,0)
      exportWrapper.style.visibility = "hidden"; // è¨­ç‚ºä¸å¯è¦‹ (ä½†ä»å¯è¢«æ“·å–)
      exportWrapper.style.zIndex = "-10"; // æ”¾åˆ°æœ€å¾Œé¢
      // âŒ (ç§»é™¤ 'left: "-9999px"')

      exportWrapper.style.display = "flex";
      exportWrapper.style.background = "#ffffff";
      exportWrapper.style.padding = `${PADDING}px`;

      // 5. å»ºç«‹å·¦å´ "å­¸å¹´åº¦æ¨™ç±¤" (ä¸è®Š)
      const labelsDiv = document.createElement("div");
      labelsDiv.style.width = `${LABEL_WIDTH}px`;
      labelsDiv.style.marginRight = "20px";
      labelsDiv.style.display = "flex";
      labelsDiv.style.flexDirection = "column";

      mapData.sortedYears.forEach((year) => {
        const label = document.createElement("div");
        label.innerText = getYearText(year);
        label.style.fontWeight = "bold";
        label.style.fontSize = "18px";
        label.style.height = `${mapData.V_GAP}px`;
        label.style.paddingTop = "10px"; 
        labelsDiv.appendChild(label);
      });
      exportWrapper.appendChild(labelsDiv);

      // 6. å»ºç«‹ "ç´”åœ°åœ–" åœ–ç‰‡ (ä¸è®Š)
      const mapImage = new Image();
      mapImage.src = dataUrl;
      mapImage.style.width = `${nodesBounds.width}px`;
      mapImage.style.height = `${nodesBounds.height}px`;

      // 7. ç­‰å¾…åœ–ç‰‡è¼‰å…¥ (ä¸è®Š)
      await new Promise((resolve, reject) => {
        mapImage.onload = resolve;
        mapImage.onerror = reject; // åŠ ä¸ŠéŒ¯èª¤è™•ç†
      });

      // 8. å°‡åœ–ç‰‡åŠ å…¥ DOM (ä¸è®Š)
      exportWrapper.appendChild(mapImage);
      document.body.appendChild(exportWrapper);

      // 9. æ“·å– "çµ„åˆå¾Œ" çš„å®Œæ•´åœ–ç‰‡ (ä¸è®Š)
      //    åŠ å…¥ cacheBust: true ç¢ºä¿åœ–ç‰‡æœ€æ–°
      const finalImage = await toPng(exportWrapper, {
        pixelRatio: 2,
        cacheBust: true,
      });

      // 10. æ¸…ç†æˆ°å ´ (ä¸è®Š)
      document.body.removeChild(exportWrapper);

      // 11. è§¸ç™¼ä¸‹è¼‰ (ä¸è®Š)
      if (type === "PNG") {
        const a = document.createElement("a");
        a.href = finalImage;
        a.download = "curriculum-map.png";
        a.click();
      } else if (type === "PDF") {
        // (PDF é‚è¼¯ä¸è®Š)
        const { width, height } = exportWrapper.getBoundingClientRect();
        const orientation = width > height ? "l" : "p";
        const pdf = new jsPDF(orientation, "px", [width, height]);
        pdf.addImage(finalImage, "PNG", 0, 0, width, height);
        pdf.save("curriculum-map.pdf");
      }

    } catch (err) {
      console.error("åŒ¯å‡ºå¤±æ•—:", err);
    } finally {
      onExportEnd();
    }
  };

  // ... (ExportComponent çš„ return JSX ä¸è®Š)
  return (
  	<div className="flex flex-col space-y-2">
  	  <button
  	  	onClick={() => exportImage("PNG")}
  	  	disabled={isExporting} // åŠ ä¸Š disabled
  	  	className="px-3 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" // åŠ ä¸Š className
  	  >
  	  	{isExporting ? "åŒ¯å‡ºä¸­..." : "åŒ¯å‡º PNG"}
  	  </button>
  	  <button
  	  	onClick={() => exportImage("PDF")}
      disabled={isExporting} // åŠ ä¸Š disabled
  	  	className="px-3 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" // åŠ ä¸Š className
  	  >
  	  	{isExporting ? "åŒ¯å‡ºä¸­..." : "åŒ¯å‡º PDF"}
  	  </button>
  	</div>
  );
}

// =========================================================
// Hover
// =========================================================
const CustomNode = memo(({ data }) => {
  const course = data.course;
  const firstCat = course.categories?.[0] || null;

  // â— ä¿®æ”¹é» (2)ï¼šå¢åŠ  hover ç‹€æ…‹
  const [isHovered, setIsHovered] = useState(false);

  return (
    // â— ä¿®æ”¹é» (3)ï¼šåœ¨æ ¹å…ƒç´ ä¸Šåµæ¸¬ hover
    <div 
      className="relative group select-none"
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >

      {/* â— ä¿®æ”¹é» (4)ï¼šä½¿ç”¨ NodeToolbar 
          - isVisible æ§åˆ¶é¡¯ç¤º
          - position æ§åˆ¶å¾å“ªé‚Šå½ˆå‡º
          - offset æ§åˆ¶è·é›¢
      */}
      <NodeToolbar 
        isVisible={isHovered} 
        position={Position.Right} // ä½ å¯ä»¥æ”¹æˆ .Left, .Top, .Bottom
        offset={10} 
      >
        {/* æŠŠä½ åŸæœ¬çš„ Tooltip div æ¬é€²ä¾† */}
        {/* â— ä¿®æ”¹é» (5)ï¼šç§»é™¤æ‰€æœ‰ absolute å’Œ z-index å®šä½ class */}
        <div
          className="bg-white text-black text-sm p-3 rounded shadow-lg w-56 pointer-events-none"
        >
          <div className="font-semibold text-base mb-1">{course.course_name}</div>
          <div className="text-gray-700">å­¸åˆ†ï¼š{course.credits}</div>
          <div className="text-gray-700">å¹´ç´šï¼š{course.year_text}</div>
          <div className="text-gray-700">å­¸æœŸï¼š{course.semester || "æœªæŒ‡å®š"}</div>
          <div className="mt-2">
            <div className="text-gray-600 text-sm mb-1">åˆ†é¡ï¼š</div>
            <div className="flex flex-wrap gap-1">
              {(course.categories || []).map((cat, i) => (
                <span
                  key={i}
                  className="px-2 py-1 rounded text-xs text-white"
                  style={{ background: categoryColor(cat) }}
                >
                  {cat}
                </span>
              ))}
            </div>
          </div>
        </div>
      </NodeToolbar>

      {/* ä¸»å¡ç‰‡ */}
      <div
        className="rounded-lg shadow-md text-white px-3 py-2 cursor-pointer border"
        style={{
          width: 200,
          background: firstCat ? categoryColor(firstCat) : "#6b7280",
          borderColor: "#ffffff33",
        }}
      >
        <div className="font-semibold">{course.course_name}</div>
        <div className="text-sm opacity-90">{course.credits} å­¸åˆ†</div>

        <div className="flex flex-wrap gap-1 mt-1">
          {(course.categories || []).map((cat, i) => (
            <span
              key={i}
              className="px-1 py-[2px] rounded text-xs"
              style={{
                background: "#ffffff33",
                border: "1px solid rgba(255,255,255,0.4)",
              }}
            >
              {cat}
            </span>
          ))}
        </div>
      </div>

      {/*{/* Tooltipï¼ˆæ°¸ä¸è¢« ReactFlow è¦†è“‹ï¼‰ 
      <div
        className="absolute hidden group-hover:block z-[999999999] left-full top-1 ml-2 
          bg-white text-black text-sm p-3 rounded shadow-lg w-56 pointer-events-none"
      >
        <div className="font-semibold text-base mb-1">{course.course_name}</div>
        <div className="text-gray-700">å­¸åˆ†ï¼š{course.credits}</div>
        <div className="text-gray-700">å¹´ç´šï¼š{course.year_text}</div>
        <div className="text-gray-700">å­¸æœŸï¼š{course.semester || "æœªæŒ‡å®š"}</div>

        <div className="mt-2">
          <div className="text-gray-600 text-sm mb-1">åˆ†é¡ï¼š</div>
          <div className="flex flex-wrap gap-1">
            {(course.categories || []).map((cat, i) => (
              <span
                key={i}
                className="px-2 py-1 rounded text-xs text-white"
                style={{ background: categoryColor(cat) }}
              >
                {cat}
              </span>
            ))}
          </div>
        </div>
      </div>*/}

      <Handle type="target" position={Position.Top} />
      <Handle type="source" position={Position.Bottom} />
    </div>
  );
});

// =========================================================
// ğŸ—ºï¸ ä¸»çµ„ä»¶ CurriculumMap
// =========================================================
export default function CurriculumMap() {
  const [depts, setDepts] = useState([]);
  //  ç›®å‰åªæ”¯æ´510
  const [deptId, setDeptId] = useState(510);

  const [nodes, setNodes] = useState([]);
  const [edges, setEdges] = useState([]);

  const [selectedCourse, setSelectedCourse] = useState(null);
  const [loading, setLoading] = useState(false);

  const nodeTypes = { customNode: CustomNode };

  const [isExporting, setIsExporting] = useState(false);

  const [isInfoPanelCollapsed, setIsInfoPanelCollapsed] = useState(false);

  const [mapData, setMapData] = useState({ sortedYears: [], V_GAP: 180 });
  const toggleInfoPanel = () => {
    setIsInfoPanelCollapsed(!isInfoPanelCollapsed);
  };
  // å–å¾—ç³»æ‰€
  useEffect(() => {
    axios.get("http://localhost:3001/api/departments").then((res) => {
      setDepts(res.data || []);
    });}
    , []);
  
  const onExportPNG = useCallback(() => {
    // .react-flow__renderer æ˜¯ React Flow ç¹ªè£½ç¯€é»å’Œé‚Šçš„ DOM å…ƒç´ 
    const flowElement = document.querySelector(".react-flow__renderer");
    if (!flowElement) {
      console.error("æ‰¾ä¸åˆ° React Flow å…ƒç´ ");
      return;
    }
    setIsExporting(true);

    toPng(flowElement, { backgroundColor: "#ffffff", cacheBust: true })
      .then((dataUrl) => {
        // å»ºç«‹ä¸€å€‹å‡çš„ <a> é€£çµä¾†è§¸ç™¼ä¸‹è¼‰
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = "curriculum-map.png";
        a.click();
      })
      .catch((err) => {
        console.error("åŒ¯å‡º PNG å¤±æ•—:", err);
      })
      .finally(() => {
        setIsExporting(false);
      });
  }, []);

// â— 4. [æ–°å¢] åŒ¯å‡º PDF çš„å‡½å¼
const onExportPDF = useCallback(() => {
    const flowElement = document.querySelector(".react-flow__renderer");
    if (!flowElement) {
      console.error("æ‰¾ä¸åˆ° React Flow å…ƒç´ ");
      return;
    }
    setIsExporting(true);

    toPng(flowElement, { backgroundColor: "#ffffff", cacheBust: true })
      .then((dataUrl) => {
        // å–å¾—åœ–ç‰‡çš„åŸå§‹å¯¬é«˜
        const { width, height } = flowElement.getBoundingClientRect();
        // åˆ¤æ–· PDF æ‡‰è©²æ˜¯ç›´å‘(p)é‚„æ˜¯æ©«å‘(l)
        const orientation = width > height ? "l" : "p";
        
        // 'px' è¡¨ç¤ºå–®ä½æ˜¯åƒç´ 
        const pdf = new jsPDF(orientation, "px", [width, height]);
        
        // å°‡åœ–ç‰‡åŠ å…¥ PDF
        pdf.addImage(dataUrl, "PNG", 0, 0, width, height);
        pdf.save("curriculum-map.pdf");
      })
      .catch((err) => {
        console.error("åŒ¯å‡º PDF å¤±æ•—:", err);
      })
      .finally(() => {
        setIsExporting(false);
      });
  }, []);
  // å–å¾—å­¸ç¨‹åœ°åœ–
  const fetchCurriculum = useCallback(async () => {
    setLoading(true);

    const res = await axios.get(`http://localhost:3001/api/curriculum/${deptId}`);
    const { courses, prerequisites } = res.data;

    // ä¾å¹´ç´šåˆ†çµ„
    const groups = {};
    courses.forEach((c) => {
      const year = c.year_level || 999;
      if (!groups[year]) groups[year] = [];
      groups[year].push(c);
    });

    const sortedYears = Object.keys(groups).map(Number).sort((a, b) => a - b);

    const H_GAP = 260;
    const V_GAP = 180;

    setMapData({sortedYears,V_GAP})
    const nodeList = [];
    sortedYears.forEach((year, rowIndex) => {
      groups[year].forEach((c, colIndex) => {
        nodeList.push({
          id: String(c.course_id),
          type: "customNode",
          data: { course: c },
          position: {
            x: colIndex * H_GAP,
            y: rowIndex * V_GAP,
          },
        });
      });
    });

    const edgeList = prerequisites.map((p) => ({
      id: `e${p.prereq_id}-${p.course_id}`,
      source: String(p.prereq_id),
      target: String(p.course_id),
      animated: true,
      type: "smoothstep",
    }));

    setNodes(nodeList);
    setEdges(edgeList);
    setLoading(false);
  }, [deptId]);

  useEffect(() => {
    fetchCurriculum();
  }, [fetchCurriculum]);

  return (
    <div className="flex h-full bg-gray-100">
      {/* å·¦å´ï¼šå­¸ç¨‹åœ– */}
      <div className="flex-1 p-4 flex flex-col">
        <div className="flex items-center justify-between mb-4 flex-shrink-0">
          {/*<h1 className="text-2xl font-bold">å­¸ç¨‹åœ°åœ–</h1>*/}
          <div className="flex items-center space-x-2">
  	  	  	{/* èˆŠçš„æŒ‰éˆ•æœƒè¢« ExportComponent å–ä»£ */}
  	  	  	<select
  	  	  	  className="border p-2 rounded"
  	  	  	  value={deptId}
  	  	  	  onChange={(e) => setDeptId(e.target.value)}
  	  	  	>
  	  	  	  {depts.map((d) => (
  	  	  	  	<option key={d.dept_id} value={d.dept_id}>
  	  	  	  	  {d.dept_name}
  	  	  	  	</option>
  	  	  	  ))}
  	  	  	</select>
          </div>
        </div>

      <div className="relative bg-white rounded shadow flex-1" style={{ height: "80vh", minHeight: 500 }}>
         {/* â— 10. [æ–°å¢] åŒ…è£¹ ReactFlowProvider */}
        <ReactFlowProvider>
        <FlowErrorBoundary>
          {/* â— 2. ä½¿ç”¨ AnimatePresence åŒ…è£¹è¼‰å…¥ç‹€æ…‹ */}
          <AnimatePresence>
            {loading && (
              // è¼‰å…¥ä¸­å‹•ç•«
              <motion.div
                key="loader"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="absolute inset-0 flex justify-center items-center bg-white/60 z-10"
              >
                è¼‰å…¥ä¸­â€¦
              </motion.div>
            )}
          </AnimatePresence>

          {/* â— 3. ReactFlow æ¼¸å…¥å‹•ç•« (åœ¨ loading ç‚º false æ™‚) */}
          <AnimatePresence>
            {!loading && (
              <motion.div
                key="reactflow"
                className="absolute inset-0"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ duration: 0.5 }}
              >
                <ReactFlow
                  nodes={nodes}
                  edges={edges}
                  nodeTypes={nodeTypes}
                  fitView
                  fitViewOptions={{ padding: 0.3 }}
                  proOptions={{ hideAttribution: true }}
                  onNodeClick={(e, node) => {
                      const clickedCourse = node.data.course;
                      // æª¢æŸ¥æ˜¯å¦é»æ“Šäº† "å·²ç¶“è¢«é¸ä¸­" çš„èª²ç¨‹
                      if (selectedCourse && selectedCourse.course_id === clickedCourse.course_id) {
                        // å¦‚æœæ˜¯ï¼Œå°±"åˆ‡æ›" (toggle) é¢æ¿
                        toggleInfoPanel();
                      } else {
                        // å¦å‰‡ (é»äº†æ–°èª²ç¨‹)
                        // 1. è¨­å®šæ–°èª²ç¨‹
                        setSelectedCourse(clickedCourse);
                        // 2. å¼·åˆ¶"å±•é–‹"é¢æ¿
                        setIsInfoPanelCollapsed(false);
                      }
                    }}
                  >
                  <MiniMap />
                  <Controls />
                  <Background gap={16} />
                  <div div className="absolute bottom-4 right-4 z-10">
                    <ExportComponent 
                      isExporting={isExporting}
                      onExportStart={() => setIsExporting(true)}
                      onExportEnd={() => setIsExporting(false)}
                      mapData={mapData}
                      />
                      {isExporting && <div style={{ color: '#555', fontSize: '12px', marginTop: '5px' }}>åŒ¯å‡ºä¸­...</div>}
                  </div>
                </ReactFlow>
              </motion.div>
            )}
          </AnimatePresence>
        </FlowErrorBoundary>
        </ReactFlowProvider>
      </div>
    </div>
      
      {/* å³å´è³‡è¨Šé¢æ¿ */}
      <motion.div
        initial={{ x: "100%" }}
        animate={{ x: "0%" }}
        transition={{ type: "spring", stiffness: 300, damping: 30 }}
        // åŠ ä¸Šå‹•æ…‹å¯¬åº¦ã€å‹•ç•«ã€å’Œ overflow-x-hidden
        // ä¹ŸæŠŠ p-5 æ”¹æˆ p-4 è®“æ”¶åˆæ™‚æŒ‰éˆ•æ›´å”èª¿
        className={`bg-white border-l p-4 shadow-lg overflow-y-auto overflow-x-hidden 
          ${isInfoPanelCollapsed ? "w-16" : "w-96"} 
          transition-all duration-300 ease-in-out flex flex-col`}
      >
        {/* æ”¶åˆæŒ‰éˆ• */}
        <button
          onClick={toggleInfoPanel}
          //æŒ‰éˆ•é å³
          className="p-2 rounded hover:bg-gray-200 mb-4 self-end flex-shrink-0"
        >
          {isInfoPanelCollapsed ? "â†" : "â†’"}
        </button>

        {/*  å‹•ç•«å…§å®¹åŒ…è£å™¨ (åŒå·¦å´ Sidebar é‚è¼¯) */}
        <div
          className={`whitespace-nowrap overflow-hidden transition-all duration-300 ${
            isInfoPanelCollapsed ? "w-0 opacity-0" : "w-full opacity-100"
          }`}
        >
          {selectedCourse ? (
            <>
              <h2 className="text-xl font-bold mb-2">
                {selectedCourse.course_name}
              </h2>
              <p className="text-gray-600">å­¸åˆ†ï¼š{selectedCourse.credits}</p>
              <p className="text-gray-600">å¹´ç´šï¼š{selectedCourse.year_text}</p>
              <p className="text-gray-600">å­¸æœŸï¼š{selectedCourse.semester}</p>

              <div className="mt-3">
                <div className="text-gray-600">åˆ†é¡ï¼š</div>
                <div className="flex flex-wrap gap-2 mt-1">
                  {(selectedCourse.categories || []).map((cat, i) => (
                    <span
                      key={i}
                      className="px-2 py-1 rounded text-sm text-white"
                      style={{ background: categoryColor(cat) }}
                    >
                      {cat}
                   </span>
                  ))}
                </div>
              </div>
            </>
          ) : (
            <div className="text-gray-500">é»æ“Šå·¦å´ç¯€é»æŸ¥çœ‹èª²ç¨‹è³‡è¨Š</div>
         )}
        </div>
      </motion.div>
    </div>
  );
}